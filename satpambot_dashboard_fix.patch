From 2fcb95da96d0662b80139b51321ddababdd982c9 Mon Sep 17 00:00:00 2001
From: Nama Kamu <emailkamu@example.com>
Date: Sat, 16 Aug 2025 13:16:19 +0700
Subject: [PATCH] fix(dashboard): ensure templates exist + logout nav; add
 /settings, /servers, /api/live, /dashboard; dual-path template loader & login
 loop guard

---
 satpambot/dashboard/app.py                    | 374 +++++++-----------
 satpambot/dashboard/static/js/mini_monitor.js |  29 +-
 satpambot/dashboard/templates/base.html       | 141 ++++++-
 satpambot/dashboard/templates/dashboard.html  |  86 +---
 satpambot/dashboard/templates/login.html      |  57 +--
 satpambot/dashboard/templates/login.html.bak  |  58 +++
 .../templates/partials/logout_nav.html        |   6 +
 .../templates/partials/mini_monitor.html      |  39 +-
 .../dashboard/templates/settings_theme.html   |  85 +---
 satpambot/dashboard/templates/topbar.html     |  30 +-
 10 files changed, 433 insertions(+), 472 deletions(-)
 create mode 100644 satpambot/dashboard/templates/login.html.bak
 create mode 100644 satpambot/dashboard/templates/partials/logout_nav.html

diff --git a/satpambot/dashboard/app.py b/satpambot/dashboard/app.py
index 575dcde..d97fca5 100644
--- a/satpambot/dashboard/app.py
+++ b/satpambot/dashboard/app.py
@@ -1,9 +1,10 @@
+import os, time, random
+from flask import Flask, session, redirect, url_for, request, render_template, jsonify
 
-import os
+# Explicit folders but relative to project root if run with PYTHONPATH=.
+app = Flask("main", template_folder="templates", static_folder="static")
 
 from functools import wraps
-from flask import session, redirect, url_for, request
-
 def login_required(fn):
     @wraps(fn)
     def wrapper(*args, **kwargs):
@@ -11,229 +12,23 @@ def login_required(fn):
             return redirect(url_for("login", next=request.url))
         return fn(*args, **kwargs)
     return wrapper
-import json
-import sqlite3
-from datetime import datetime
-from functools import wraps
-from pathlib import Path
-
-from flask import Flask, request, jsonify, render_template, redirect, url_for, session
-from flask_socketio import SocketIO
-from werkzeug.utils import secure_filename
-
-app = Flask("main", static_folder="static", template_folder="templates")
-app.config["SECRET_KEY"] = os.getenv("SESSION_SECRET", os.getenv("SECRET_KEY", "satpambot-dev"))
-socketio = SocketIO(app, cors_allowed_origins="*", async_mode="threading")
-
-BASE_DIR = Path(__file__).resolve().parent
-DATA_DIR = BASE_DIR / "data"
-DATA_DIR.mkdir(exist_ok=True)
-DB_PATH = DATA_DIR / "app.db"
-CFG_PATH = DATA_DIR / "config.json"
-
-def init_db():
-    with sqlite3.connect(DB_PATH) as c:
-        c.execute("CREATE TABLE IF NOT EXISTS assets (key TEXT PRIMARY KEY, mime TEXT, data BLOB, updated_at TEXT)")
-        c.execute("""CREATE TABLE IF NOT EXISTS asset_history (
-                        id INTEGER PRIMARY KEY AUTOINCREMENT,
-                        category TEXT, filename TEXT, mime TEXT, url TEXT, data BLOB,
-                        is_active INTEGER DEFAULT 0, created_at TEXT
-                    )""")
-        c.commit()
-
-def bootstrap():
-    init_db()
-    if not CFG_PATH.exists():
-        CFG_PATH.write_text(json.dumps({"theme": "default.css"}, indent=2), encoding="utf-8")
-    return True
-
-def login_required(fn):
-    @wraps(fn)
-    def wrapper(*args, **kwargs):
-        if not session.get("admin"):
-            return redirect(url_for("login", next=request.url))
-        return fn(*args, **kwargs)
-    return wrapper
-
-def _save_asset(category: str, local_path: Path, url: str) -> str:
-    mime = "image/png" if local_path.suffix.lower() == ".png" else "image/jpeg"
-    raw = local_path.read_bytes()
-    with sqlite3.connect(DB_PATH) as conn:
-        conn.execute("REPLACE INTO assets(key, mime, data, updated_at) VALUES (?,?,?,?)",
-                     (category, mime, raw, datetime.utcnow().isoformat()))
-        conn.execute("UPDATE asset_history SET is_active=0 WHERE category=?", (category,))
-        conn.execute("""INSERT INTO asset_history(category, filename, mime, url, data, is_active, created_at)
-                        VALUES (?,?,?,?,?,1,?)""", (category, local_path.name, mime, url, raw, datetime.utcnow().isoformat()))
-        conn.commit()
-    socketio.emit("asset_updated", {"category": category, "url": url}, broadcast=True)
-    return url
-
-def _theme_name() -> str:
-    if CFG_PATH.exists():
-        try:
-            cfg = json.loads(CFG_PATH.read_text(encoding="utf-8"))
-            return cfg.get("theme", "default.css")
-        except Exception:
-            pass
-    return "default.css"
-
 
-@app.route("/ping", methods=["GET","HEAD"])
-def ping():
-    return "pong", 200
+app.config['SECRET_KEY'] = os.getenv('SECRET_KEY', 'dev-secret-key-please-change')
+app.jinja_env.globals['cache_bust'] = os.getenv('CACHE_BUST', '1')
 
-from flask import redirect
+@app.get("/ping")
+def ping(): return "pong", 200
 
-@app.route('/assets/<path:filename>')
-def _assets(filename):
-    return _sfd(_ASSETS_DIR, filename)
+@app.get("/healthz")
+def healthz(): return "ok", 200
 
-
-# --- admin fallback integration ---
-import os
-try:
-    app.config['SECRET_KEY'] = os.getenv('FLASK_SECRET_KEY', 'dev-key')
-    app.config['SESSION_COOKIE_SAMESITE'] = 'Lax'
-    app.config['SESSION_COOKIE_SECURE'] = bool(os.getenv('SESSION_COOKIE_SECURE','1')!='0')
-except Exception:
-    pass
-try:
-    from .admin_fallback import admin_fallback_bp
-except Exception:
-    from .admin_fallback import admin_fallback_bp
-try:
-    app.register_blueprint(admin_fallback_bp)
-except Exception:
-    pass
-
-# Aliases so these URLs always work
-from flask import redirect
-
-
-
-
-
-
-
-
-try:
-    from flask import redirect
-    # Root -> /login jika belum ada rule '/'
-    if not any(getattr(r, "rule", None) == "/" for r in app.url_map.iter_rules()):
-        @app.route("/")
-        def __root_redirect_to_login():
-            return redirect("/login", code=302)
-    # /discord/login -> /login jika belum ada rule '/discord/login'
-    if not any(getattr(r, "rule", None) == "/discord/login" for r in app.url_map.iter_rules()):
-        @app.route("/discord/login")
-        def __discord_login_redirect_to_login():
-            return redirect("/login", code=302)
-except Exception:
-    pass
-
-
-# --- force alias to /login (safe; runs before routes) ---
-try:
-    from flask import request, redirect
-    @app.before_request
-    def _force_login_alias():
-        if request.path in ("/", "/discord/login"):
-            return redirect("/login", code=302)
-except Exception:
-    pass
-
-
-# --- hard override: force /login to use admin_fallback, plus aliases ---
-try:
-    from flask import request, redirect
-    from .admin_fallback import admin_login  # form user/pass (ENV)
-    @app.before_request
-    def _login_overrides():
-        # Aliases menuju /login
-        if request.path in ("/", "/discord/login"):
-            return redirect("/login", code=302)
-        # Paksa /login selalu pakai admin_fallback (hindari handler lama "Invalid request!")
-        if request.path == "/login" and request.method in ("GET","POST"):
-            return admin_login()
-except Exception:
-    pass
-
-
-# --- API fallback saat bot OFF (dipasang hanya kalau route belum ada) ---
-try:
-    import os
-    from flask import jsonify
-    # /api/live
-    if not any(getattr(r, "rule", None) == "/api/live" for r in app.url_map.iter_rules()):
-        @app.get("/api/live")
-        def __api_live_fallback():
-            return jsonify(ok=True, live=True, bot="off", env=os.getenv("ENV","local")), 200
-    # /api/ping
-    if not any(getattr(r, "rule", None) == "/api/ping" for r in app.url_map.iter_rules()):
-        @app.get("/api/ping")
-        def __api_ping_fallback():
-            return jsonify(ok=True, pong=True), 200
-except Exception:
-    pass
-
-
-# --- quiet access log for health/ping routes & lightweight endpoints ---
-try:
-    import logging
-    from flask import request, jsonify
-
-    _QUIET_PATHS = {"/ping", "/healthz", "/api/ping", "/api/live"}
-
-    @app.before_request
-    def __mute_health_accesslog():
-        # tandai request agar tidak dilog kalau termasuk quiet paths atau healthcheck UA
-        ua = (request.headers.get("User-Agent") or "").lower()
-        if request.path in _QUIET_PATHS or "uptimerobot" in ua or "render" in ua:
-            # flag khusus yang kita cek di after_request
-            request.environ["_suppress_access_log"] = True
-
-    @app.after_request
-    def __custom_accesslog(resp):
-        # kalau tidak health/ping, tulis access log sederhana via logger 'entry'
-        try:
-            if not request.environ.get("_suppress_access_log"):
-                logging.getLogger("entry").info("%s %s %s", request.method, request.path, resp.status_code)
-        except Exception:
-            pass
-        return resp
-
-    # Sediakan /ping dan /healthz kalau belum ada (HEAD/GET, no body 204)
-    if not any(getattr(r, "rule", None) == "/ping" for r in app.url_map.iter_rules()):
-        @app.route("/ping", methods=["GET","HEAD"])
-        def __ping(): return ("", 204)
-    if not any(getattr(r, "rule", None) == "/healthz" for r in app.url_map.iter_rules()):
-        @app.route("/healthz", methods=["GET","HEAD"])
-        def __healthz(): return ("", 204)
-
-    # Fallback API (kalau bot OFF): /api/ping & /api/live
-    if not any(getattr(r, "rule", None) == "/api/ping" for r in app.url_map.iter_rules()):
-        @app.get("/api/ping")
-        def __api_ping_fallback(): return jsonify(ok=True, pong=True), 200
-    if not any(getattr(r, "rule", None) == "/api/live" for r in app.url_map.iter_rules()):
-        @app.get("/api/live")
-        def __api_live_fallback(): return jsonify(ok=True, live=True, bot="off"), 200
-except Exception:
-    pass
-
-
-
-
-# --- LOGIN (compat baseline) ---
-@app.route("/login", methods=["GET", "POST"])
+@app.route("/login", methods=["GET","POST"])
 def login():
     if request.method == "POST":
-        user = request.form.get("user", "")
-        pw = request.form.get("pass", "")
-        user_env = os.getenv("ADMIN_USERNAME", os.getenv("SUPER_ADMIN_USER", "admin"))
-        pass_env = (os.getenv("ADMIN_PASSWORD")
-                    or os.getenv("SUPER_ADMIN_PASS")
-                    or os.getenv("SUPER_ADMIN_PASSWORD")
-                    or "admin")
+        user = request.form.get("user","")
+        pw = request.form.get("pass","")
+        user_env = os.getenv("ADMIN_USERNAME", os.getenv("SUPER_ADMIN_USER","admin"))
+        pass_env = (os.getenv("ADMIN_PASSWORD") or os.getenv("SUPER_ADMIN_PASS") or os.getenv("SUPER_ADMIN_PASSWORD") or "admin")
         if user == user_env and pw == pass_env:
             session["admin"] = user
             nxt = request.args.get("next")
@@ -241,15 +36,16 @@ def login():
         return render_template("login.html", error="Kredensial salah.")
     return render_template("login.html", error=None)
 
-
-
 @app.route("/admin/login", methods=["GET","POST"])
 def admin_login():
     if request.method == "POST":
         return login()
     return redirect(url_for("login"))
 
-
+@app.get("/logout")
+def logout():
+    session.pop("admin", None)
+    return redirect(url_for("login"))
 
 @app.before_request
 def __root_conditional_dashboard():
@@ -265,8 +61,132 @@ def __root_conditional_dashboard():
 def __root_dashboard():
     return render_template("dashboard.html")
 
+# --- API stubs for dashboard ---
+@app.get("/api/stats")
+def api_stats():
+    return jsonify({
+        "online": random.randint(5, 60),
+        "messages_today": random.randint(100, 900),
+        "warnings": random.randint(0, 5),
+        "uptime": time.strftime("%H:%M:%S", time.gmtime(time.time()%86400)),
+    })
 
-@app.get("/logout")
-def logout():
-    session.pop("admin", None)
-    return redirect(url_for("login"))
+@app.get("/api/traffic")
+def api_traffic():
+    labels = [f"{h:02d}:00" for h in range(24)]
+    values = [random.randint(0, 50) for _ in labels]
+    return jsonify({"labels": labels, "values": values})
+
+@app.get("/api/top_guilds")
+def api_top():
+    return jsonify([{"name": f"Guild {i}", "count": random.randint(1, 99)} for i in range(1,7)])
+
+@app.get("/api/mini-monitor")
+def api_mm():
+    return jsonify({"uptime": "3d 12h", "cpu": round(random.uniform(4, 27),1), "ram": random.randint(350, 1200)})
+
+
+@app.get("/settings")
+@login_required
+def settings_page():
+    # render template from package templates; ChoiceLoader already set
+    return render_template("settings.html")
+
+
+@app.get("/servers")
+@login_required
+def servers_page():
+    # render template from package templates
+    return render_template("servers.html")
+
+
+@app.get("/api/live")
+def __api_live_fallback():
+    from flask import jsonify
+    return jsonify(ok=True, live=True, bot=os.getenv("RUN_BOT","0") not in ("0","false","False"))
+# === PATCH START: dashboard templates/routing ===
+import os
+from jinja2 import ChoiceLoader, FileSystemLoader
+from functools import wraps
+
+# Dual template loader (package + root)
+try:
+    pkg_templates = os.path.join(os.path.dirname(__file__), "templates")
+    root_templates = os.path.abspath(os.path.join(os.path.dirname(__file__), "..", "..", "..", "templates"))
+    loaders = []
+    if os.path.isdir(pkg_templates):
+        loaders.append(FileSystemLoader(pkg_templates))
+    if os.path.isdir(root_templates):
+        loaders.append(FileSystemLoader(root_templates))
+    if loaders:
+        app.jinja_loader = ChoiceLoader(loaders)
+except Exception:
+    pass
+
+# login_required (ringan) bila belum ada
+try:
+    login_required
+except NameError:
+    def login_required(fn):
+        @wraps(fn)
+        def wrapper(*args, **kwargs):
+            if not (session.get("admin") or session.get("oauth") or session.get("discord_user")):
+                return redirect(url_for("login", next=request.url))
+            return fn(*args, **kwargs)
+        return wrapper
+
+# Hindari loop redirect pada /login
+@app.before_request
+def __login_loop_guard():
+    p = request.path or "/"
+    if p in ("/login", "/admin/login"):
+        return None
+
+# Alias /dashboard
+@app.get("/dashboard")
+@login_required
+def dashboard_alias():
+    return render_template("dashboard.html")
+
+# Halaman settings & servers
+@app.get("/settings")
+@login_required
+def settings_page():
+    return render_template("settings.html")
+
+@app.get("/servers")
+@login_required
+def servers_page():
+    return render_template("servers.html")
+
+# Liveness sederhana untuk front-end
+@app.get("/api/live")
+def __api_live_fallback():
+    from flask import jsonify
+    live = str(os.getenv("RUN_BOT","0")).lower() not in ("0","false")
+    return jsonify(ok=True, live=bool(live))
+
+# Debug: lihat search paths & keberadaan file
+@app.get("/__debug/templates")
+def __debug_templates():
+    from flask import jsonify
+    paths = []
+    try:
+        loader = app.jinja_loader
+        loaders = getattr(loader, "loaders", [loader])
+        for L in loaders:
+            sp = getattr(L, "searchpath", None)
+            if isinstance(sp, (list,tuple)):
+                paths.extend(list(sp))
+            elif isinstance(sp, str):
+                paths.append(sp)
+    except Exception:
+        pass
+    names = ["base.html","login.html","dashboard.html","settings.html","servers.html"]
+    found = {}
+    for base in paths:
+        for n in names:
+            fp = os.path.join(base, n)
+            found[fp] = os.path.exists(fp)
+    return jsonify(paths=paths, found=found)
+# === PATCH END ===
diff --git a/satpambot/dashboard/static/js/mini_monitor.js b/satpambot/dashboard/static/js/mini_monitor.js
index 2f829ee..d6b7918 100644
--- a/satpambot/dashboard/static/js/mini_monitor.js
+++ b/satpambot/dashboard/static/js/mini_monitor.js
@@ -1,12 +1,17 @@
-async function refreshMini(){
-  try{
-    const d = await (await fetch("/api/mini-monitor",{cache:"no-store"})).json(); // { uptime, cpu, ram }
-    const u = document.getElementById("mm-uptime");
-    const c = document.getElementById("mm-cpu");
-    const r = document.getElementById("mm-ram");
-    if(u) u.textContent = "Uptime: " + (d.uptime || "--");
-    if(c) c.textContent = "CPU: " + (d.cpu ?? "--") + "%";
-    if(r) r.textContent = "RAM: " + (d.ram ?? "--") + " MB";
-  }catch(e){}
-}
-refreshMini(); setInterval(refreshMini, 4000);
+
+(function(){
+  async function tick(){
+    try{
+      const res = await fetch('/api/live_stats', {cache:'no-store'});
+      if(!res.ok){ return; }
+      const j = await res.json();
+      if(j && j.uptime){
+        document.getElementById('mm-uptime').textContent = 'Uptime: ' + j.uptime;
+        document.getElementById('mm-cpu').textContent = 'CPU: ' + j.cpu + '%';
+        document.getElementById('mm-ram').textContent = 'RAM: ' + j.ram + ' MB';
+      }
+    }catch(e){ /* silent */ }
+  }
+  tick();
+  setInterval(tick, 3000);
+})();
diff --git a/satpambot/dashboard/templates/base.html b/satpambot/dashboard/templates/base.html
index c58e768..e42c477 100644
--- a/satpambot/dashboard/templates/base.html
+++ b/satpambot/dashboard/templates/base.html
@@ -1,14 +1,129 @@
-<!doctype html>
-<html lang="id">
-<head>
-  <meta charset="utf-8">
-  <meta name="viewport" content="width=device-width,initial-scale=1">
-  <title>{% block title %}{% endblock %} ¬∑ SatpamBot</title>
-  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
-  {% block head %}{% endblock %}
+<!doctype html><html><head><meta charset='utf-8'><meta name='viewport' content='width=device-width,initial-scale=1'><title>SatpamBot</title>
+<link rel='stylesheet' href='{{ theme_path }}'><style>body{background:#0b0b16 url('{{ background_image }}') center/cover fixed no-repeat;color:#e8e8ef;font-family:Inter,system-ui,Segoe UI,Arial,sans-serif;margin:0}
+.container{max-width:1100px;margin:32px auto;padding:0 16px}.card{background:#0f1017;border:1px solid #1a1c29;border-radius:14px;padding:16px;margin-bottom:12px}.btn{background:#2c2f45;color:#fff;border:none;border-radius:10px;padding:8px 12px;cursor:pointer}
+nav{display:flex;gap:12px;align-items:center;margin-bottom:16px}nav a{color:#fff;text-decoration:none;opacity:.85}nav a:hover{opacity:1}</style><!-- SB_THEME_GLOBAL_HEAD -->
+<style>
+:root{
+  --bg:#0b0e14; --card:#141923; --border:#222b3b; --text:#e6e6e6;
+  --muted:#a8b0c2; --sb-bg-url:''; --sb-bg-opacity:0.15;
+}
+[data-theme="light"]{
+  --bg:#f6f7fb; --card:#ffffff; --border:#e6e8ef; --text:#1f2737; --muted:#4b5565;
+}
+html,body{min-height:100%}
+body{background:var(--bg); color:var(--text);}
+body::before{
+  content:""; position:fixed; inset:0; z-index:-1;
+  background-image:var(--sb-bg-url); background-size:cover; background-position:center;
+  opacity:var(--sb-bg-opacity); filter:blur(0px); pointer-events:none;
+}
+.sb-theme-hide-bg body::before{display:none;}
+/* Container transparan tipis agar bg kelihatan lembut */
+.sb-translucent .card, .sb-translucent main, .sb-translucent .container {
+  background-color: color-mix(in hsl, var(--card) 92%, transparent);
+}
+/* Widget */
+#sb-theme-widget{
+  position:fixed; top:10px; right:10px; z-index:9999;
+  background:var(--card); border:1px solid var(--border); border-radius:12px;
+  padding:10px; box-shadow:0 8px 28px rgba(0,0,0,.35); font: 14px/1.3 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
+}
+#sb-theme-widget .row{display:flex; gap:6px; align-items:center; margin-top:6px}
+#sb-theme-widget input[type="url"]{min-width:260px; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:transparent; color:var(--text)}
+#sb-theme-widget input[type="range"]{width:130px}
+#sb-theme-widget button{
+  padding:8px 10px; border:1px solid var(--border); border-radius:10px; background:transparent; color:var(--text); cursor:pointer; font-weight:600;
+}
+#sb-theme-widget .primary{background:#5865F2; border-color:#5865F2; color:#fff}
+#sb-theme-widget .muted{opacity:.8}
+#sb-theme-widget .mini{position:absolute; top:6px; right:6px; padding:2px 8px; border-radius:8px; font-size:12px}
+#sb-theme-widget.collapsed .body{display:none}
+</style>
+<script>
+(()=>{try{
+  // init theme from localStorage
+  const t = localStorage.getItem("sb_theme")||"dark";
+  if(t==="light") document.documentElement.setAttribute("data-theme","light");
+  // init bg url & opacity
+  const url = localStorage.getItem("sb_bg_url")||"";
+  const op  = localStorage.getItem("sb_bg_opacity")||"0.15";
+  if(url){
+    document.documentElement.style.setProperty("--sb-bg-url", `url("${url}")`);
+  } else {
+    document.documentElement.style.setProperty("--sb-bg-url", "none");
+  }
+  document.documentElement.style.setProperty("--sb-bg-opacity", op);
+}catch(e){}})();
+</script>
+
 </head>
-<body class="{% block body_class %}{% endblock %}">
-{% block body %}{% endblock %}
-<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
-</body>
-</html>
+<body><div class='container'><nav><a href='/dashboard'>Dashboard</a><a href='/servers'>Servers</a><a href='/settings'>Pengaturan</a><a href='/assets-manager'>Assets</a><div style='flex:1'></div><a href='/logout'>Logout</a></nav>
+{% block content %}{% endblock %}</div><!-- SB_THEME_GLOBAL_WIDGET -->
+<div id="sb-theme-widget" class="sb-translucent">
+  <button class="mini muted" id="sb-mini">‚Äì</button>
+  <div class="row">
+    <button id="sb-theme" class="primary" title="Toggle dark/light">Theme</button>
+    <button id="sb-back" title="Back">Back</button>
+  </div>
+  <div class="body">
+    <div class="row">
+      <input id="sb-bg-url" type="url" placeholder="Background URL (contoh: /assets/bg.jpg)">
+    </div>
+    <div class="row">
+      <span class="muted">Opacity</span>
+      <input id="sb-bg-op" type="range" min="0" max="0.7" step="0.01">
+      <button id="sb-clear" class="muted" title="Hapus background">Clear</button>
+    </div>
+  </div>
+</div>
+<script>
+(()=>{try{
+  const $ = (id)=>document.getElementById(id);
+  const w = $("sb-theme-widget"); if(!w) return;
+  const btnTheme = $("sb-theme");
+  const btnBack  = $("sb-back");
+  const mini     = $("sb-mini");
+  const inpUrl   = $("sb-bg-url");
+  const inpOp    = $("sb-bg-op");
+  const btnClear = $("sb-clear");
+
+  // hydrate inputs
+  inpUrl.value = localStorage.getItem("sb_bg_url")||"";
+  inpOp.value  = localStorage.getItem("sb_bg_opacity")||"0.15";
+
+  function applyBg(){
+    const u = inpUrl.value.trim();
+    localStorage.setItem("sb_bg_url", u);
+    document.documentElement.style.setProperty("--sb-bg-url", u?`url("${u}")`:"none");
+  }
+  function applyOp(){
+    const v = inpOp.value;
+    localStorage.setItem("sb_bg_opacity", v);
+    document.documentElement.style.setProperty("--sb-bg-opacity", v);
+  }
+  btnClear.onclick = ()=>{ inpUrl.value=""; applyBg(); };
+
+  btnTheme.onclick = ()=>{
+    const isLight = document.documentElement.getAttribute("data-theme")==="light";
+    if(isLight){ document.documentElement.removeAttribute("data-theme"); localStorage.setItem("sb_theme","dark"); }
+    else { document.documentElement.setAttribute("data-theme","light"); localStorage.setItem("sb_theme","light"); }
+  };
+  btnBack.onclick = ()=>{
+    if(history.length>1) history.back(); else window.location.href = "/";
+  };
+  mini.onclick = ()=>{
+    w.classList.toggle("collapsed");
+    mini.textContent = w.classList.contains("collapsed") ? "+" : "‚Äì";
+  };
+
+  inpUrl.addEventListener("change", applyBg);
+  inpOp.addEventListener("input", applyOp);
+
+  // auto collapse di layar kecil
+  if(Math.min(window.innerWidth, window.innerHeight) < 520){
+    w.classList.add("collapsed"); mini.textContent = "+";
+  }
+}catch(e){}})();
+</script>
+
+</body></html>
\ No newline at end of file
diff --git a/satpambot/dashboard/templates/dashboard.html b/satpambot/dashboard/templates/dashboard.html
index 0e9e210..bee4795 100644
--- a/satpambot/dashboard/templates/dashboard.html
+++ b/satpambot/dashboard/templates/dashboard.html
@@ -1,80 +1,6 @@
-{% extends "base.html" %}
-{% block title %}Dashboard{% endblock %}
-{% block body %}
-<div class="container-fluid py-3">
-  <div class="row g-3">
-    <div class="col-6 col-md-3">
-      <div class="card h-100">
-        <div class="card-body">
-          <div class="text-muted">Users Online</div>
-          <div class="fs-3 fw-semibold" id="m-users">--</div>
-        </div>
-      </div>
-    </div>
-    <div class="col-6 col-md-3">
-      <div class="card h-100">
-        <div class="card-body">
-          <div class="text-muted">Messages Today</div>
-          <div class="fs-3 fw-semibold" id="m-msg">--</div>
-        </div>
-      </div>
-    </div>
-    <div class="col-6 col-md-3">
-      <div class="card h-100">
-        <div class="card-body">
-          <div class="text-muted">Warnings</div>
-          <div class="fs-3 fw-semibold text-warning" id="m-warn">--</div>
-        </div>
-      </div>
-    </div>
-    <div class="col-6 col-md-3">
-      <div class="card h-100">
-        <div class="card-body">
-          <div class="text-muted">Uptime</div>
-          <div class="fs-3 fw-semibold" id="m-uptime">--</div>
-        </div>
-      </div>
-    </div>
-  </div>
-
-  <div class="row g-3 mt-1">
-    <div class="col-lg-8">
-      <div class="card h-100">
-        <div class="card-body">
-          <div class="d-flex justify-content-between align-items-center mb-2">
-            <h6 class="mb-0">Traffic</h6>
-            <small class="text-muted" id="traffic-range">Last 24h</small>
-          </div>
-          <canvas id="chart-traffic" height="110"></canvas>
-        </div>
-      </div>
-    </div>
-    <div class="col-lg-4">
-      <div id="mini-monitor" class="card" style="margin-bottom:1rem;">
-        <div class="card-body">
-          <div class="d-flex justify-content-between align-items-center">
-            <div>
-              <div style="font-weight:600;">Mini Monitor</div>
-              <div id="mm-uptime" style="opacity:.8;font-size:.9rem;">Uptime: --</div>
-            </div>
-            <div style="text-align:right;">
-              <div id="mm-cpu" style="font-weight:600;">CPU: --%</div>
-              <div id="mm-ram" style="opacity:.8;">RAM: -- MB</div>
-            </div>
-          </div>
-        </div>
-      </div>
-
-      <div class="card h-100">
-        <div class="card-body">
-          <h6 class="mb-2">Top Guilds</h6>
-          <ul class="list-group list-group-flush small" id="top-guilds"></ul>
-        </div>
-      </div>
-    </div>
-  </div>
-</div>
-
-<script src="{{ url_for('static', filename='js/dashboard.js') }}?v={{ cache_bust|default(1) }}"></script>
-<script src="{{ url_for('static', filename='js/mini_monitor.js') }}?v={{ cache_bust|default(1) }}"></script>
-{% endblock %}
+{% extends "base.html" %}{% block content %}
+<div class='card'><h2>Traffic</h2><div id='traffic'>-</div></div>
+<div class='card'><h2>Incident</h2><div id='incident'>0</div></div>
+<script>
+async function refresh(){const r=await fetch('/api/live');const j=await r.json();document.getElementById('traffic').textContent=`CPU: ${j.cpu??'-'}% ‚Ä¢ MEM: ${j.mem??'-'}% ‚Ä¢ Req: ${j.requests}`;document.getElementById('incident').textContent=(j.incidents_series||[]).reduce((a,b)=>a+b,0);}setInterval(refresh,5000);refresh();
+</script>{% endblock %}
\ No newline at end of file
diff --git a/satpambot/dashboard/templates/login.html b/satpambot/dashboard/templates/login.html
index 58c352a..5d64d35 100644
--- a/satpambot/dashboard/templates/login.html
+++ b/satpambot/dashboard/templates/login.html
@@ -1,27 +1,36 @@
-{% extends "base.html" %}
-{% block title %}Login{% endblock %}
-{% block body %}
-<div class="auth-wrap">
-  <canvas id="particle-canvas" aria-hidden="true"></canvas>
-
-  <div class="login-card card shadow-lg">
-    <div class="card-body">
-      <h5 class="mb-3 text-center">Masuk Dashboard</h5>
-      <form method="post" action="{{ url_for('login') }}">
-        <div class="mb-3">
-          <label class="form-label">Username</label>
-          <input name="username" class="form-control form-control-lg" autocomplete="username" required />
-        </div>
-        <div class="mb-3">
-          <label class="form-label">Password</label>
-          <input type="password" name="password" class="form-control form-control-lg" autocomplete="current-password" required />
-        </div>
-        <button class="btn btn-primary w-100 btn-lg">Login</button>
-      </form>
-    </div>
+{% extends 'base.html' %}
+{% block title %}Masuk Dashboard - SatpamBot{% endblock %}
+{% block content %}
+<canvas id="particle-canvas" style="position:fixed;inset:0;z-index:0"></canvas>
+<div class="container" style="position:relative;z-index:1;max-width:540px;margin-top:10vh">
+  <div class="card">
+    <h2 style="text-align:center">Masuk Dashboard</h2>
+    {% if error %}<div class="badge" style="color:#ff6b81">Kredensial salah</div>{% endif %}
+    <form method="post">
+      <div class="form-group" style="margin-bottom:10px">
+        <label>Username</label>
+        <input name="user" class="input" style="width:100%" required />
+      </div>
+      <div class="form-group" style="margin-bottom:12px">
+        <label>Password</label>
+        <input type="password" name="pass" class="input" style="width:100%" required />
+      </div>
+      <button class="btn primary" style="width:100%">Login</button>
+    </form>
   </div>
 </div>
-
-<link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}?v={{ cache_bust|default(1) }}">
-<script src="{{ url_for('static', filename='js/particles_login.js') }}?v={{ cache_bust|default(1) }}"></script>
+{% endblock %}
+{% block extra_scripts %}
+<script src="{{ url_for('static', filename='js/particles.min.js') }}"></script>
+<script>
+// simple particles background init
+(function(){
+  const c = document.getElementById('particle-canvas');
+  if(!c || !window.particlesJS) return;
+  particlesJS('particle-canvas', {
+    particles:{ number:{value:60}, color:{value:'#9aa4b2'}, size:{value:2}, line_linked:{enable:true, distance:140, color:'#9aa4b2', opacity:0.5, width:1} },
+    interactivity:{ detect_on:'canvas', events:{ onhover:{enable:true, mode:'repulse'} } }
+  });
+})();
+</script>
 {% endblock %}
diff --git a/satpambot/dashboard/templates/login.html.bak b/satpambot/dashboard/templates/login.html.bak
new file mode 100644
index 0000000..8038308
--- /dev/null
+++ b/satpambot/dashboard/templates/login.html.bak
@@ -0,0 +1,58 @@
+<!doctype html>
+<meta name=viewport content="width=device-width, initial-scale=1">
+<title>SatpamBot ‚Ä¢ Admin Login</title>
+<style>
+:root{--bg:#0b0e14;--card:#141923;--border:#222b3b;--text:#e6e6e6;--muted:#a8b0c2;--sb-bg-url:'';--sb-bg-opacity:0.15}
+[data-theme="light"]{--bg:#f6f7fb;--card:#ffffff;--border:#e6e8ef;--text:#1f2737;--muted:#4b5565}
+html,body{height:100%}body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--text);display:grid;place-items:center;margin:0}
+body::before{content:"";position:fixed;inset:0;z-index:-1;background-image:var(--sb-bg-url);background-size:cover;background-position:center;opacity:var(--sb-bg-opacity)}
+.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:28px;min-width:360px;max-width:520px;box-shadow:0 8px 32px rgba(0,0,0,.35)}
+.brand{display:flex;gap:10px;align-items:center;margin-bottom:12px}
+.brand svg{width:28px;height:28px}
+input,button{width:100%;padding:12px 14px;border-radius:10px;font-size:15px}
+input{border:1px solid var(--border);background:transparent;color:var(--text);margin-top:8px}
+button{margin-top:16px;border:none;background:#5865F2;color:#fff;font-weight:700;cursor:pointer}
+.err{color:#ff6b6b;margin:8px 0 0 0;font-size:.92rem}
+#widget{position:fixed;top:10px;right:10px;background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;box-shadow:0 8px 28px rgba(0,0,0,.35);}
+#widget input[type=url]{min-width:240px;padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:transparent;color:var(--text)}
+#widget input[type=range]{width:120px}
+#widget button{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:transparent;color:var(--text);cursor:pointer;font-weight:600}
+#widget .primary{background:#5865F2;border-color:#5865F2;color:#fff}
+</style>
+<div id="widget">
+  <div><button id="theme" class="primary">Theme</button> <button id="back">Back</button></div>
+  <div style="margin-top:6px">
+    <input id="bg" type="url" placeholder="Background URL"><input id="op" type="range" min="0" max="0.7" step="0.01" value="0.15">
+  </div>
+</div>
+<div class=card>
+  <div class=brand>
+    <svg viewBox='0 0 24 24' fill='#5865F2'><path d='M12 2l3 4 5 1-3 4 1 5-6-3-6 3 1-5-3-4 5-1z'/></svg>
+    <h2 style='margin:0'>SatpamBot ‚Ä¢ Admin</h2>
+  </div>
+  {% if err %}<div class=err>{{ err }}</div>{% endif %}
+  <form method="POST" action="">
+    <label>Username</label>
+    <input name="username" autocomplete="username" required>
+    <label>Password</label>
+    <input name="password" type="password" autocomplete="current-password" required>
+    <button type="submit">Login</button>
+  </form>
+</div>
+<script>
+(function(){
+  try{
+    var t=localStorage.getItem("sb_theme")||"dark";
+    if(t==="light") document.documentElement.setAttribute("data-theme","light");
+    var u=localStorage.getItem("sb_bg_url")||""; var o=localStorage.getItem("sb_bg_opacity")||"0.15";
+    document.querySelector("#bg").value=u; document.querySelector("#op").value=o;
+    var apply=function(){ var url=document.querySelector("#bg").value.trim(); localStorage.setItem("sb_bg_url",url); document.documentElement.style.setProperty("--sb-bg-url",url?`url("${url}")`:"none"); };
+    var applyOp=function(){ var v=document.querySelector("#op").value; localStorage.setItem("sb_bg_opacity",v); document.documentElement.style.setProperty("--sb-bg-opacity",v); };
+    apply(); applyOp();
+    document.querySelector("#bg").addEventListener("change",apply);
+    document.querySelector("#op").addEventListener("input",applyOp);
+    document.querySelector("#theme").onclick=function(){ var isLight=document.documentElement.getAttribute("data-theme")==="light"; if(isLight){ document.documentElement.removeAttribute("data-theme"); localStorage.setItem("sb_theme","dark"); } else { document.documentElement.setAttribute("data-theme","light"); localStorage.setItem("sb_theme","light"); } };
+    document.querySelector("#back").onclick=function(){ if(history.length>1) history.back(); else location.href="/"; };
+  }catch(e){}
+})();
+</script>
diff --git a/satpambot/dashboard/templates/partials/logout_nav.html b/satpambot/dashboard/templates/partials/logout_nav.html
new file mode 100644
index 0000000..35fba91
--- /dev/null
+++ b/satpambot/dashboard/templates/partials/logout_nav.html
@@ -0,0 +1,6 @@
+<div style="position:sticky;top:0;z-index:50;background:rgba(10,11,15,.65);backdrop-filter:blur(8px);padding:8px 12px;margin:-16px -16px 16px -16px;display:flex;gap:8px;align-items:center;justify-content:flex-end;">
+  <a href="{{ url_for('__root_dashboard') }}" class="btn" style="text-decoration:none;padding:8px 12px;border-radius:10px;background:#1f2937;color:#e5e7eb">Dashboard</a>
+  <a href="{{ url_for('settings_page') }}" class="btn" style="text-decoration:none;padding:8px 12px;border-radius:10px;background:#1f2937;color:#e5e7eb">Settings</a>
+  <a href="{{ url_for('servers_page') }}" class="btn" style="text-decoration:none;padding:8px 12px;border-radius:10px;background:#1f2937;color:#e5e7eb">Servers</a>
+  <a href="{{ url_for('logout') }}" class="btn" style="text-decoration:none;padding:8px 12px;border-radius:10px;background:#ef4444;color:#fff">Logout</a>
+</div>
diff --git a/satpambot/dashboard/templates/partials/mini_monitor.html b/satpambot/dashboard/templates/partials/mini_monitor.html
index 0b236f1..e29c669 100644
--- a/satpambot/dashboard/templates/partials/mini_monitor.html
+++ b/satpambot/dashboard/templates/partials/mini_monitor.html
@@ -1,25 +1,16 @@
-<script>
-(function(){
-  const $uptime = document.getElementById('mm-uptime');
-  const $cpu    = document.getElementById('mm-cpu');
-  const $ram    = document.getElementById('mm-ram');
 
-  async function tick(){
-    try {
-      const r = await fetch('/api/live', {cache:'no-store'});
-      if (!r.ok) throw new Error('live not ok');
-      const j = await r.json();
-
-      if ($uptime) $uptime.textContent = 'Uptime: ' + (j.uptime_human || '--');
-      if ($cpu)    $cpu.textContent    = 'CPU: ' + (j.cpu_percent ?? '--') + '%';
-      if ($ram)    $ram.textContent    = 'RAM: ' + (j.ram_mb ?? '--') + ' MB';
-    } catch(_) {
-      // fallback ringan agar tidak spam
-      try { await fetch('/api/ping', {cache:'no-store'}); } catch(e){}
-    } finally {
-      setTimeout(tick, 12000); // 12s, biar adem
-    }
-  }
-  tick();
-})();
-</script>
+<div id="mini-monitor" class="card" style="margin-bottom:1rem;">
+  <div class="card-body">
+    <div class="d-flex justify-content-between align-items-center">
+      <div>
+        <div style="font-weight:600;">Mini Monitor</div>
+        <div id="mm-uptime" style="opacity:.8;font-size:.9rem;">Uptime: --</div>
+      </div>
+      <div style="text-align:right;">
+        <div id="mm-cpu" style="font-weight:600;">CPU: --%</div>
+        <div id="mm-ram" style="opacity:.8;">RAM: -- MB</div>
+      </div>
+    </div>
+  </div>
+</div>
+<script src="/static/js/mini_monitor.js?v={{ cache_bust }}"></script>
diff --git a/satpambot/dashboard/templates/settings_theme.html b/satpambot/dashboard/templates/settings_theme.html
index 181bcda..70da5f8 100644
--- a/satpambot/dashboard/templates/settings_theme.html
+++ b/satpambot/dashboard/templates/settings_theme.html
@@ -1,76 +1,19 @@
-{% extends "base.html" %}
-{% block title %}Theme & Branding{% endblock %}
+{% extends 'base.html' %}
+{% block title %}Ganti Tema - SatpamBot{% endblock %}
 {% block content %}
-<div class="card">
-  <h2 style="margin:0 0 12px">üé® Theme & Branding</h2>
-
-  <form action="/theme/apply" method="post" style="display:grid;gap:14px">
-    <div style="display:grid;gap:8px">
-      <label>Mode Tema</label>
-      <div style="display:flex;gap:10px;flex-wrap:wrap">
-        <label><input type="radio" name="mode" value="dark"  {% if theme_mode=='dark' %}checked{% endif %}> Dark</label>
-        <label><input type="radio" name="mode" value="light" {% if theme_mode=='light' %}checked{% endif %}> Light</label>
-        <label><input type="radio" name="mode" value="auto"  {% if theme_mode=='auto' %}checked{% endif %}> Auto (ikut OS)</label>
-      </div>
-    </div>
-
-    <div style="display:grid;gap:8px">
-      <label>Background URL (opsional, akan disimpan ke server)</label>
-      <input type="text" name="bg_url" placeholder="https://..." value="{{ bg_url or '' }}">
-      <label style="display:flex;align-items:center;gap:8px">
-        <input type="checkbox" name="use_on_login" value="1" {% if use_bg_on_login %}checked{% endif %}>
-        Gunakan background ini juga untuk halaman login
-      </label>
-      <div style="display:flex;gap:10px;flex-wrap:wrap">
-        <a href="/theme/list" class="btn">üìÅ Lihat daftar background</a>
-        <a href="#" class="btn" onclick="previewBg();return false;">üëÅÔ∏è Preview</a>
-        <a href="#" class="btn" onclick="saveBgLocal();return false;">üíæ Simpan ke Local (client)</a>
-      </div>
-    </div>
-
-    <div style="display:grid;gap:8px">
-      <label>Logo URL (opsional)</label>
-      <input type="text" name="logo_url" placeholder="https://..." value="{{ logo_url or '' }}">
-      <div style="display:flex;gap:10px;flex-wrap:wrap">
-        <a href="#" class="btn" onclick="saveLogoLocal();return false;">üíæ Simpan Logo ke Local</a>
-      </div>
-    </div>
-
-    <button class="btn primary" type="submit">Simpan ke Server</button>
+<div class="card" style="padding:16px; max-width: 640px;">
+  <h4 style="margin-bottom:12px;">Ganti Theme</h4>
+  <form method="POST" class="row g-2" style="display:flex;gap:10px;align-items:center;">
+    <select name="theme" class="form-select" style="max-width:280px;">
+      {% for t in available_themes %}
+        <option value="{{ t }}" {% if t == current_theme %}selected{% endif %}>{{ t }}</option>
+      {% endfor %}
+    </select>
+    <button class="btn btn-primary" type="submit">Simpan</button>
+    <a class="btn btn-outline-secondary" href="/theme?set={{ current_theme or 'neon.css' }}">Apply</a>
   </form>
-
-  <hr style="margin:20px 0;border:none;border-top:1px solid var(--border)">
-
-  <div style="display:grid;gap:12px">
-    <h3>Upload File</h3>
-    <form action="/upload/background" method="post" enctype="multipart/form-data" style="display:flex;gap:10px;flex-wrap:wrap">
-      <input type="file" name="background" accept="image/*">
-      <button class="btn" type="submit">Upload Background</button>
-    </form>
-    <form action="/upload/logo" method="post" enctype="multipart/form-data" style="display:flex;gap:10px;flex-wrap:wrap">
-      <input type="file" name="logo" accept="image/*">
-      <button class="btn" type="submit">Upload Logo</button>
-    </form>
+  <div style="margin-top:10px;">
+    <small class="text-muted">File dibaca dari <code>/static/themes/*.css</code>. Background global tetap.</small>
   </div>
 </div>
-
-<script>
-  function previewBg(){
-    const v = document.querySelector('input[name="bg_url"]').value.trim();
-    if(!v) return alert('Masukkan BG URL dulu');
-    document.documentElement.style.setProperty('--bg-image', `url("${v}")`);
-  }
-  function saveBgLocal(){
-    const v = document.querySelector('input[name="bg_url"]').value.trim();
-    if(!v) return alert('Masukkan BG URL dulu');
-    localStorage.setItem('bgUrl', v);
-    alert('Background disimpan ke localStorage ‚úî');
-  }
-  function saveLogoLocal(){
-    const v = document.querySelector('input[name="logo_url"]').value.trim();
-    if(!v) return alert('Masukkan Logo URL dulu');
-    localStorage.setItem('logoUrl', v);
-    alert('Logo disimpan ke localStorage ‚úî');
-  }
-</script>
 {% endblock %}
diff --git a/satpambot/dashboard/templates/topbar.html b/satpambot/dashboard/templates/topbar.html
index 8aa4c85..38e64f7 100644
--- a/satpambot/dashboard/templates/topbar.html
+++ b/satpambot/dashboard/templates/topbar.html
@@ -1,23 +1,11 @@
 <div class="topbar">
-  <div class="left">
-    <button class="btn" onclick="goBack()">‚Üê Back</button>
-    {% if logo_url %}
-      <img class="logo" src="{{ logo_url }}" alt="logo" />
-    {% else %}
-      <script>
-        (function(){
-          const u = localStorage.getItem('logoUrl');
-          if (u){
-            const img = new Image();
-            img.src = u; img.className='logo'; img.alt='logo';
-            document.currentScript.parentElement.appendChild(img);
-          }
-        })();
-      </script>
-    {% endif %}
-  </div>
-  <div class="right">
-    <a class="btn" href="/theme">üé® Theme</a>
-    <button class="btn" onclick="toggleTheme()">üåì Theme</button>
-  </div>
+    <div>
+        <button id="toggleSidebar" class="btn btn-sm btn-light me-2">‚ò∞</button>
+        <strong>Dashboard SatpamBot</strong>
+    </div>
+    <div>
+        üë§ {{ username or 'Guest' }}
+        <button id="toggleTheme" class="btn btn-sm btn-secondary ms-3">üåì</button>
+    </div>
 </div>
+
-- 
2.50.1.windows.1

