(function(){
  async function getPhash(){try{const r=await fetch('/api/phish/phash',{cache:'no-store'});if(!r.ok)return;const d=await r.json();const arr=Array.isArray(d.phash)?d.phash:[];const c=document.getElementById('phashCount');const p=document.getElementById('phashPreview');if(c)c.textContent=arr.length;if(p)p.textContent=JSON.stringify(arr.slice(0,100),null,2);}catch(e){}}
  async function exportPhash(){const r=await fetch('/api/phish/phash',{cache:'no-store'});if(!r.ok)return;const blob=new Blob([await r.text()],{type:'application/json'});const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='phash_export.json';a.click();URL.revokeObjectURL(a.href);}
  function wireDrop(){const drop=document.getElementById('dropZone'),pick=document.getElementById('fileInput'),log=document.getElementById('uploadLog'),ln=s=>{if(log)log.innerHTML+=s+'<br>';};drop.addEventListener('click',()=>pick.click());pick.addEventListener('change',e=>{for(const f of e.target.files)up(f);pick.value='';});['dragenter','dragover'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.add('dragover');}));['dragleave','drop'].forEach(ev=>drop.addEventListener(ev,e=>{e.preventDefault();drop.classList.remove('dragover');}));drop.addEventListener('drop',e=>{const fs=e.dataTransfer?.files||[];for(const f of fs)up(f);});async function up(file){const fd=new FormData();fd.append('file',file,file.name);try{const r=await fetch('/dashboard/security/upload',{method:'POST',body:fd});const j=await r.json();if(r.ok&&j.ok)ln('✅ '+file.name+' → '+j.saved);else ln('❌ '+file.name+' ('+(j.error||r.status)+')');}catch(e){ln('❌ '+file.name+' (error)');}}}
  window.addEventListener('DOMContentLoaded',()=>{getPhash();setInterval(getPhash,5000);const R=document.getElementById('btnRefresh'),E=document.getElementById('btnExport');if(R)R.addEventListener('click',getPhash);if(E)E.addEventListener('click',exportPhash);if(document.getElementById('dropZone'))wireDrop();});
})();