#!/usr/bin/env bash
set -euo pipefail

STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACMRTUXB || true)
EXCLUDES='^(hooks/|\.git/hooks/|README|readme|docs/|.*example.*)$'
PATTERN_VALUES='(gsk_[A-Za-z0-9_-]{20,}|AIza[0-9A-Za-z_-]{20,}|sk-[A-Za-z0-9]{20,}|[A-Za-z0-9_-]{24,}\.[A-Za-z0-9_-]{6}\.[A-Za-z0-9_-]{27,})'

has_secret=0
while IFS= read -r f; do
  [[ -z "$f" ]] && continue
  if [[ "$f" =~ $EXCLUDES ]]; then
    continue
  fi
  DIFF=$(git diff --cached -U0 -- "$f" | sed -n 's/^+//p' || true)
  if echo "$DIFF" | grep -Eiq "$PATTERN_VALUES"; then
    echo "â›” Commit blocked: possible secret value in: $f"
    has_secret=1
  fi
done <<< "$STAGED_FILES"

if [[ $has_secret -eq 1 ]]; then
  echo "Tip: pindahkan token ke ENV / satpambot_config.local.json (gitignored)"
  exit 1
fi
exit 0
