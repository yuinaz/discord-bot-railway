
<!doctype html>
<meta charset="utf-8"/>
<title>SatpamBot â€” Users & Guilds</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="stylesheet" href="/static/dashboard.css"/>
<div class="container" style="max-width:960px">
  <h1>Users & Guilds</h1>
  <div id="intro" class="card" style="display:none"></div>
  <div id="grid" class="grid"></div>
</div>
<style>
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:12px}
.badge{display:inline-block;padding:2px 8px;border:1px solid #2a3347;border-radius:9999px;font-size:12px;color:#cbd5e1}
</style>
<script>
async function load(){
  const blockIntro = document.querySelector('#intro');
  const grid = document.querySelector('#grid');
  try{
    const res = await fetch('/api/uglist');
    if(!res.ok){ grid.innerHTML = "<div class='card'>Gagal memuat. <a class='btn primary' href='/discord/login'>Login Discord</a></div>"; return; }
    const js = await res.json();
    const list = (js && js.data) || [];
    grid.innerHTML = '';
    if(!list.length){
      grid.innerHTML = "<div class='card'>Tidak ada guild yang bisa dikelola. <a class='btn primary' href='/discord/login'>Login Discord</a></div>";
      return;
    }
    for(const g of list){
      const div = document.createElement('div');
      div.className = 'card';
      const mem = g.member_count != null ? `<span class="badge">Members: ${g.member_count}</span>` : '';
      const bot = `<span class="badge">Bot: ${g.bot_present ? 'Hadir' : 'Tidak'}</span>`;
      const mng = `<span class="badge">${g.manageable ? 'Manageable' : 'Readonly'}</span>`;
      const actions = g.bot_present && g.manageable ? `
        <div class="row" style="margin-top:8px">
          <button class="btn primary" data-act="status" data-id="${g.id}">Status</button>
          <button class="btn" data-act="say" data-id="${g.id}" data-ch="${g.system_channel_id||''}">Say halo</button>
        </div>
      ` : `
        <div class="row" style="margin-top:8px">
          <a class="btn primary" href="${g.invite_url}" target="_blank">Invite Bot</a>
        </div>
      `;
      div.innerHTML = `
        <div class="row">
          <div><b>${g.name}</b> <small>(id: <code>${g.id}</code>)</small></div>
        </div>
        <div class="row" style="gap:6px;margin-top:6px">${mng}${bot}${mem}</div>
        ${actions}
        <pre id="out-${g.id}" style="white-space:pre-wrap;margin-top:8px"></pre>
      `;
      grid.appendChild(div);
    }
    grid.addEventListener('click', async (e)=>{
      const b = e.target.closest('button'); if(!b) return;
      const gid = b.getAttribute('data-id');
      const out = document.querySelector('#out-'+gid);
      const act = b.getAttribute('data-act');
      if(act==='status'){
        const r = await fetch(`/api/guilds/${gid}/status`);
        out.textContent = await r.text();
      } else if(act==='say'){
        const ch = b.getAttribute('data-ch') || '';
        const r = await fetch(`/api/guilds/${gid}/say`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({channel_id: ch, content: 'Halo dari Dashboard!'})});
        out.textContent = await r.text();
      }
    });
  }catch(err){
    grid.innerHTML = "<div class='card'>Error memuat data.</div>";
  }
}
load();
</script>
