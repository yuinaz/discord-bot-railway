{% extends 'base.html' %}{% block title %}Dashboard - SatpamBot{% endblock %}{% block content %}
<link rel="preconnect" href="https://cdn.jsdelivr.net">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<div class="grid cols-4">
  <div class="card"><h4>CPU</h4><div style="position:relative;"><canvas id="cpu" class="chart-sm"></canvas><div class="center-label" id="cpuVal">0%</div></div></div>
  <div class="card"><h4>RAM</h4><div class="kpi"><span>ðŸ’¾</span><span class="val"><span id="ramVal">0</span> MB</span></div><canvas id="ramSpark" class="chart-xs"></canvas></div>
  <div class="card"><h4>Deteksi 7 Hari</h4><canvas id="line7" class="chart-sm"></canvas></div>
  <div class="card"><h4>Komposisi</h4><canvas id="comp" class="chart-sm"></canvas></div>

  <div class="card" style="grid-column: span 2;"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;"><h4>Aktivitas</h4><span class="badge">7 hari</span></div><canvas id="act" class="chart-lg"></canvas></div>
  <div class="card"><h4>Top Guilds</h4><table class="table" id="tblGuilds"><thead><tr><th>Guild</th><th>Score</th></tr></thead><tbody></tbody></table></div>
  <div class="card"><h4>Banned Top</h4><table class="table" id="tblBans"><thead><tr><th>User</th><th>Guild</th><th>Reason</th></tr></thead><tbody></tbody></table></div>
</div>

<script>
const P='#9b6bff',Y='#ffd166',M='rgba(255,255,255,.25)';
let cpuD, ramL, line7, comp, act; const ramSeries=[];

async function loadDashboard(){
  const r = await fetch('/api/dashboard'); const d = await r.json();
  // KPI
  document.getElementById('cpuVal').textContent = (d.kpi.cpu||0) + '%';
  document.getElementById('ramVal').textContent = d.kpi.ram||0;
  // CPU donut
  const used=d.kpi.cpu||0, free=Math.max(0,100-used);
  cpuD = new Chart(document.getElementById('cpu'), {type:'doughnut', data:{labels:['Used','Free'], datasets:[{data:[used,free], backgroundColor:[P,M], borderColor:'#ffffff22', borderWidth:2}]}, options:{cutout:'70%', plugins:{legend:{display:false}}}});
  // RAM spark
  ramSeries.push(d.kpi.ram||0); if(ramSeries.length>40)ramSeries.shift();
  ramL = new Chart(document.getElementById('ramSpark'), {type:'line', data:{labels:ramSeries.map((_,i)=>i+1), datasets:[{data:ramSeries, fill:true, tension:.35, borderColor:P, backgroundColor:'rgba(155,107,255,.15)'}]}, options:{plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{display:false}}, elements:{point:{radius:0}}}});
  // Line 7
  line7 = new Chart(document.getElementById('line7'), {type:'line', data:{labels:d.series.labels, datasets:[{data:d.series.values, borderColor:Y, backgroundColor:'rgba(255,209,102,.15)', fill:true, tension:.35}]}, options:{plugins:{legend:{display:false}}, elements:{point:{radius:0}}}});
  // Comp
  comp = new Chart(document.getElementById('comp'), {type:'doughnut', data:{labels:['Phishing','NSFW','Spam'], datasets:[{data:[40,35,25], backgroundColor:[P,Y,'#ff5c91'], borderColor:'#ffffff22', borderWidth:2}]}, options:{cutout:'62%', plugins:{legend:{position:'bottom'}}}});
  // Activity stacked area (reuse series)
  act = new Chart(document.getElementById('act'), {type:'line', data:{labels:d.series.labels, datasets:[
    {label:'Deteksi', data:d.series.values, borderColor:P, backgroundColor:'rgba(155,107,255,.12)', fill:true, tension:.3}
  ]}, options:{plugins:{legend:{display:false}}, elements:{point:{radius:0}}}});
  // Tables
  const tbG=document.querySelector('#tblGuilds tbody'); tbG.innerHTML='';
  (d.guilds||[]).slice(0,6).forEach(g=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${g.name||'-'}</td><td>${g.detections||0}</td>`;tbG.appendChild(tr);});
  const tbB=document.querySelector('#tblBans tbody'); tbB.innerHTML='';
  (d.bans||[]).forEach(b=>{const tr=document.createElement('tr');tr.innerHTML=`<td>${b.username||b.user_id}</td><td>${b.guild_id||'-'}</td><td>${b.reason||'-'}</td>`;tbB.appendChild(tr);});
}
loadDashboard();
</script>
{% endblock %}